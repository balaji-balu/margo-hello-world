events {
    worker_connections 1024;
}

http {
    # Upstream configuration for app1 (1 replica)
    upstream co_backend {
        server co:8080; # Service name and internal port
    }

    # Upstream configuration for app2 (2 replicas)
    # Docker's DNS handles round-robin distribution to the multiple instances of 'app2'
    upstream lo_backend {
        server lo:8080; 
    }

    # Upstream configuration for app3 (4 replicas)
    upstream en_backend {
        server en:8080;
    }

    server {
        listen 80;

        # Route requests based on the URL path (example routing logic)
        location /co {
            proxy_pass http://co_backend;
            # Add necessary headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /lo {
            proxy_pass http://lo_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /en {
            proxy_pass http://en_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location / {
            # Default location if none of the others match
            proxy_pass http://co_backend;
        }
    }
    
    # Required for Docker's internal DNS to work dynamically
    resolver 127.0.0.11 valid=5s;
}
